(()=>{
  if(window.__followBot){alert('Already running');return}
  window.__followBot=true;
  const S={run:true,delay:650,scrollDelay:900,empty:0,scrolls:0,totalFollow:0,totalSurf:0};
  const C={red:'#ef4444',redDim:'#b91c1c',blue:'#3b82f6',bg:'rgba(14,14,16,.88)',card:'0 8px 30px rgba(0,0,0,.35)'};

  const ui=document.createElement('div');
  ui.style.cssText=`position:fixed;right:12px;bottom:12px;z-index:2147483647;background:${C.bg};backdrop-filter:blur(6px);color:#fff;padding:12px 14px;border-radius:14px;box-shadow:${C.card};font:12px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;min-width:200px;text-align:center`;
  ui.innerHTML=`
    <div style="margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,.16);padding-bottom:8px;font-size:11px">
      블라이, '상위노출' 분석 서비스 :
      <a href="https://blai.co.kr?invite=늑대왕" target="_blank" rel="noopener" style="color:#9ccfff;text-decoration:underline">바로가기</a>
    </div>
    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px">
      <b style="font-size:13px">Clip Follow Surfer</b>
      <span id="bdg" style="padding:2px 8px;border-radius:999px;background:#10b981;color:#052;font-weight:700;font-size:10px;letter-spacing:.25px">서핑중</span>
    </div>
    <div id="st" style="opacity:.95"></div>
    <div id="btnRow" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
      <button id="p" style="flex:1 1 auto;width:80%;padding:4px 10px;border:0;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,.07) inset,0 2px 10px rgba(0,0,0,.25)">Stop</button>
      <button id="c" style="flex:1 1 auto;width:38%;padding:4px 10px;border:0;border-radius:10px;font-weight:700;cursor:pointer;display:none">Close</button>
    </div>
    <div style="margin-top:10px;border-top:1px solid rgba(255,255,255,.16);padding-top:4px;font-size:10px;opacity:.7">
      배포 : 2025.08.13 23:50
    </div>
  `;
  document.body.appendChild(ui);

  const ST=ui.querySelector('#st'),pBtn=ui.querySelector('#p'),cBtn=ui.querySelector('#c'),BDG=ui.querySelector('#bdg');
  const setBtnColor=(btn,bg)=>{btn.style.background=bg;btn.style.color='#fff'};
  const L={follow:'팔로우',surf:'파도타기'};
  const render=()=>{ST.textContent=`${L.follow}:${S.totalFollow} | ${L.surf}:${S.totalSurf}`};

  const setRunning=()=>{S.run=true;pBtn.textContent='Stop';setBtnColor(pBtn,C.red);pBtn.style.width='80%';cBtn.style.display='none';BDG.textContent='서핑중';BDG.style.background='#10b981';render()};
  const setPaused=()=>{S.run=false;pBtn.textContent='Resume';setBtnColor(pBtn,C.blue);pBtn.style.width='38%';cBtn.style.display='inline-block';setBtnColor(cBtn,C.redDim);BDG.textContent='휴식중';BDG.style.background='#f59e0b';render()};

  pBtn.onclick=()=>{S.run?setPaused():setRunning()};
  cBtn.onclick=()=>{try{clearInterval(loop)}catch{};try{clearInterval(scroller)}catch{};try{obs.disconnect()}catch{};window.__followBot=false;ui.remove()};
  addEventListener('keydown',e=>{if(e.key==='Escape')pBtn.click()});

  const QQ=s=>Array.from(document.querySelectorAll(s));
  const txt=e=>(e.textContent||'').replace(/\s+/g,'').trim();
  const vis=e=>{const r=e.getBoundingClientRect();return r.bottom>=0&&r.top<=innerHeight+200};
  const sleep=ms=>new Promise(r=>setTimeout(r,ms));

  function findFollowBtns(){
    return QQ('button,a,[role="button"]').filter(b=>{
      const t=txt(b);
      return /팔로우/.test(t)&&!/팔로잉|팔로우중|Following/i.test(t)&&!b.closest('[disabled],[aria-disabled="true"]')&&vis(b)
    });
  }

  // ✅ 클릭 로직: 과거에 잘 되었던 "이벤트 시퀀스"로 롤백 (mouseover → mousedown → click → mouseup)
  async function clickAllFollows(){
    let n=0;
    for(const b of findFollowBtns()){
      // 클릭 직전 상태 재확인(동적 변환 대응)
      const now=(b.innerText||b.textContent||'').trim();
      if(/팔로잉|팔로우중|Following/i.test(now)) continue;

      b.scrollIntoView({block:'center'});
      b.dispatchEvent(new MouseEvent('mouseover',{bubbles:true}));
      b.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
      b.click();
      b.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));

      n++; S.totalFollow++;
      await sleep(S.delay);
    }
    S.empty = n ? 0 : S.empty + 1;
    return n;
  }

  function extractIdFromEl(el){
    const href=(el?.getAttribute?.('href'))||'';
    const mh=href.match(/\/@([^/?#]+)/);
    if(mh)return decodeURIComponent(mh[1]);
    return null;
  }

  function randomProfileCandidate(){
    const listSel='li[class*="UIProfileListItem_list_item"],li[class^="UIProfileListItem_list_item"]';
    const items=QQ(listSel);
    const candidates=[];
    for(const li of items){
      const link=li.querySelector('a[href^="/@"],a[href*="/@"],a[role="button"],[role="button"]');
      const id=extractIdFromEl(link||li);
      if(id)candidates.push({id,link:link||li});
    }
    if(candidates.length===0)return null;
    return candidates[Math.floor(Math.random()*candidates.length)];
  }

  async function ensureMoreCandidates(){
    const listSel='li[class*="UIProfileListItem_list_item"],li[class^="UIProfileListItem_list_item"]';
    let items=QQ(listSel).filter(vis);
    if(items.length<=3){
      scrollTo(0,document.body.scrollHeight);
      await sleep(700);
      scrollBy(0,-Math.floor(innerHeight*0.5));
      await sleep(300);
      scrollTo(0,0);
      await sleep(400);
    }
    items=QQ(listSel).filter(vis);
    if(items.length<=3){
      const moreBtn=QQ('button,a,[role="button"]').find(el=>/더보기|More/i.test(el.textContent||''));
      if(moreBtn){moreBtn.click();await sleep(500);}
    }
  }

  async function surfNextProfile(){
    await ensureMoreCandidates();
    let cand=randomProfileCandidate();
    if(!cand){await ensureMoreCandidates();cand=randomProfileCandidate();}
    if(!cand)return false;
    S.totalSurf++;
    cand.link.scrollIntoView({block:'center'});
    cand.link.click();
    await sleep(500);
    const followerTab=QQ('a,button,[role="button"]').find(el=>/팔로워/i.test(el.textContent||''));
    if(followerTab)followerTab.click();
    return true;
  }

  let lastH=0,stuck=0;
  const scroller=setInterval(()=>{
    if(!S.run)return;
    scrollBy(0,Math.floor(innerHeight*0.85));
    S.scrolls++;
    const h=document.documentElement.scrollHeight;
    if(h===lastH)stuck++;else{stuck=0;lastH=h}
    if(stuck>6){scrollTo(0,0);stuck=0}
  },S.scrollDelay);

  let obs=new MutationObserver(()=>{});
  obs.observe(document.documentElement,{childList:true,subtree:true});

  const loop=setInterval(async()=>{
    if(!S.run)return;
    await clickAllFollows();render();
    // 100회 배수마다 Stop
    if(S.totalSurf>0 && S.totalSurf%100===0){setPaused();return;}
    // 팔로우 없음 5회 연속이면 파도타기
    if(S.empty>=5){
      if(await surfNextProfile()){S.empty=0;S.scrolls=0;}
    }
  },900);

  setRunning();
})();
