(()=>{
  if(window.__followBot){alert('Already running');return}
  window.__followBot=true;
  const S={run:true,delay:650,scrollDelay:900,empty:0,scrolls:0,totalFollow:0,totalSurf:0,
           visited:new Set((()=>{try{return JSON.parse(localStorage.getItem('__clipVisited__')||'[]')}catch{return[]}})())};
  const save=()=>{try{localStorage.setItem('__clipVisited__',JSON.stringify([...S.visited].slice(-500)))}catch{}};
  const C={red:'#ef4444',redDim:'#b91c1c',blue:'#3b82f6',bg:'rgba(14,14,16,.88)',card:'0 8px 30px rgba(0,0,0,.35)'};

  const ui=document.createElement('div');
  ui.style.cssText='position:fixed;right:12px;bottom:12px;z-index:2147483647;background:'+C.bg+
    ';backdrop-filter:blur(6px);color:#fff;padding:12px 14px;border-radius:14px;box-shadow:'+C.card+
    ';font:12px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;min-width:200px;text-align:center';
  
  ui.innerHTML=`
    <div style="margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,.16);padding-bottom:8px;font-size:11px">
      블라이, '상위노출' 분석 서비스 :
      <a href="https://blai.co.kr?invite=늑대왕" target="_blank" rel="noopener" style="color:#9ccfff;text-decoration:underline">바로가기</a>
    </div>
    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px">
      <b style="font-size:13px">Clip Follow Surfer</b>
      <span id="bdg" style="padding:2px 8px;border-radius:999px;background:#10b981;color:#052;font-weight:700;font-size:10px;letter-spacing:.25px">서핑중</span>
    </div>
    <div id="st" style="opacity:.95"></div>
    <div id="btnRow" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
      <button id="p" style="flex:1 1 auto;width:80%;padding:4px 10px;border:0;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,.07) inset,0 2px 10px rgba(0,0,0,.25);transition:transform .08s ease,filter .15s ease,opacity .2s ease">Stop</button>
      <button id="c" style="flex:1 1 auto;width:38%;padding:4px 10px;border:0;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,.07) inset,0 2px 10px rgba(0,0,0,.25);transition:transform .08s ease,filter .15s ease,opacity .2s ease;display:none">Close</button>
    </div>
    <div style="margin-top:10px;border-top:1px solid rgba(255,255,255,.16);padding-top:4px;font-size:10px;opacity:.7">
      배포 : 2025.08.13
    </div>
  `;
  
  document.body.appendChild(ui);

  const ST=ui.querySelector('#st'),
        pBtn=ui.querySelector('#p'),
        cBtn=ui.querySelector('#c'),
        BDG=ui.querySelector('#bdg');

  const setBtnColor=(btn,bg)=>{btn.style.background=bg;btn.style.color='#fff'};
  const addHover=(btn)=>{btn.onmouseenter=()=>btn.style.filter='brightness(1.06)';
                         btn.onmouseleave=()=>btn.style.filter='none';
                         btn.onmousedown=()=>btn.style.transform='scale(0.98)';
                         btn.onmouseup=()=>btn.style.transform='scale(1)'};
  addHover(pBtn);addHover(cBtn);

  const L={follow:'팔로우',surf:'파도타기',done:'100회 완료'};
  const render=()=>{ST.textContent=`${L.follow}:${S.totalFollow} | ${L.surf}:${S.totalSurf}`};

  const setRunning=()=>{S.run=true;pBtn.textContent='Stop';setBtnColor(pBtn,C.red);pBtn.style.width='80%';cBtn.style.display='none';
                        BDG.textContent='서핑중';BDG.style.background='#10b981';render()};
  const setPaused=()=>{S.run=false;pBtn.textContent='Resume';setBtnColor(pBtn,C.blue);
                       pBtn.style.width='38%';cBtn.style.display='inline-block';setBtnColor(cBtn,C.redDim);
                       BDG.textContent='휴식중';BDG.style.background='#f59e0b';render()};

  pBtn.onclick=()=>{S.run?setPaused():setRunning()};
  cBtn.onclick=()=>{try{clearInterval(loop)}catch{}try{clearInterval(scroller)}catch{};try{obs&&obs.disconnect()}catch{};window.__followBot=false;try{ui.remove()}catch{}};
  
  addEventListener('keydown',e=>{if(e.key==='Escape')pBtn.click()});

  const QQ=s=>Array.from(document.querySelectorAll(s));
  const txt=e=>(e.textContent||'').replace(/\s+/g,'').trim();
  const vis=e=>{const r=e.getBoundingClientRect();return r.bottom>=0&&r.top<=innerHeight+200};
  const sleep=ms=>new Promise(r=>setTimeout(r,ms));
  const getHandle=()=>{const m=location.pathname.match(/\/@([^/]+)/);return m?decodeURIComponent(m[1]):null};
  const markCurrent=()=>{const h=getHandle();if(h){S.visited.add(h);save()}};markCurrent();

  function findFollowBtns(){return QQ('button,a,[role="button"]').filter(b=>{
    const t=txt(b);return /팔로우/.test(t)&&!/팔로잉|팔로우중|Following/i.test(t)&&
    !b.closest('[disabled],[aria-disabled="true"]')&&vis(b)})}

  async function clickAllFollows(){
    let n=0;
    for(const b of findFollowBtns()){
      b.scrollIntoView({block:'center'});
      b.dispatchEvent(new MouseEvent('mouseover',{bubbles:true}));
      b.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
      b.click();
      b.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
      n++;S.totalFollow++;
      await sleep(S.delay)
    }
    S.empty=n?0:S.empty+1;
    return n
  }

  function gotoFollowerTabIfSeen(){
    const cand=QQ('a,button,[role="button"]').find(el=>/팔로워/i.test(el.textContent||''));
    if(cand){cand.click();return true}
    return false
  }

  function extractIdFromEl(el){
    let id=null;
    const href=(el.getAttribute&&el.getAttribute('href'))||'';
    const mh=href.match(/\/@([^/?#]+)/);if(mh)id=decodeURIComponent(mh[1]);
    if(!id){const t=(el.innerText||el.textContent||'').trim();
      const mt=t.match(/@([A-Za-z0-9._-]{3,32})/);if(mt)id=mt[1]}
    if(!id&&el){const idNode=el.querySelector&&el.querySelector('[class*="UIProfileListItem_txt_area"],[class*="UIProfileListItem_tit_area"]');
      if(idNode){id=(idNode.innerText||'').trim().replace(/^@/,'').replace(/\s+/g,'')}}
    if(id)id=id.replace(/^@/,'').replace(/\s+/g,'');
    if(id&&!/^[A-Za-z0-9._-]{3,32}$/.test(id))id=null;
    return id
  }

  // 방문 기록 무시하고 항상 다음 프로필 반환
  function nextProfileCandidate(){
    const listSel='li[class*="UIProfileListItem_list_item"],li[class^="UIProfileListItem_list_item"]';
    const items=QQ(listSel);
    for(const li of items){
      const link=li.querySelector('a[href^="/@"],a[href*="/@"],a[role="button"],[role="button"]');
      const id=extractIdFromEl(link||li);
      if(id) return {id,link:link||li};
    }
    return null
  }

  async function ensureMoreCandidates(){
    const listSel='li[class*="UIProfileListItem_list_item"],li[class^="UIProfileListItem_list_item"]';
    let items=QQ(listSel).filter(vis);
    if(items.length<=3){
      scrollTo(0,document.body.scrollHeight);
      await sleep(700);
      scrollBy(0,-Math.floor(innerHeight*0.5));
      await sleep(300);
      scrollTo(0,0);
      await sleep(400)
    }
    items=QQ(listSel).filter(vis);
    if(items.length<=3){
      const moreBtn=QQ('button,a,[role="button"]').find(el=>/더보기|More/i.test(el.textContent||''));
      if(moreBtn){moreBtn.click();await sleep(500)}
    }
  }

  async function surfNextProfile(){
    await ensureMoreCandidates();
    let cand=nextProfileCandidate();
    if(!cand)return false;
    S.visited.add(cand.id);S.totalSurf++;save();
    cand.link.scrollIntoView({block:'center'});
    cand.link.click();
    await sleep(500);
    gotoFollowerTabIfSeen();
    return true
  }

  let lastH=0,stuck=0;
  const scroller=setInterval(()=>{
    if(!S.run)return;
    scrollBy(0,Math.floor(innerHeight*0.85));
    S.scrolls++;
    const h=document.documentElement.scrollHeight;
    if(h===lastH)stuck++;else{stuck=0;lastH=h}
    if(stuck>6){scrollTo(0,0);stuck=0}
  },S.scrollDelay);

  let justNavigated=false,
      obs=new MutationObserver(()=>{
        if(justNavigated)return;
        const h=getHandle();
        if(h&&!S.visited.has(h)){S.visited.add(h);save()}
        if(QQ('[class*="UIProfileInfo"],[class*="UIProfileHeader"]').length){
          gotoFollowerTabIfSeen()
        }
      });

  obs.observe(document.documentElement,{childList:true,subtree:true});

  const loop=setInterval(async()=>{
    if(!S.run)return;
    await clickAllFollows();render();
    if(S.totalSurf>0 && S.totalSurf % 100 === 0){ // 100의 배수일 때 정지
      setPaused();
      return;
    }
    if(S.empty>=5){
      if(await surfNextProfile()){
        justNavigated=true;
        setTimeout(()=>justNavigated=false,1200);
        S.empty=0;S.scrolls=0
      }
    }
  },900);

  setRunning();
})();
